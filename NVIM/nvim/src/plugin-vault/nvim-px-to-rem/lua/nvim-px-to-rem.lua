local a={}local b=require("utils")a.options={root_font_size=16,decimal_count=4,show_virtual_text=true,add_cmp_source=true,disable_keymaps=false,filetypes={"css","scss","sass"}}a.setup=function(c)c=c or{}a.options=vim.tbl_deep_extend("keep",c,a.options)vim.api.nvim_create_user_command("PxToRemCursor",a.px_to_rem_at_cursor,{})vim.api.nvim_create_user_command("PxToRemLine",a.px_to_rem_on_line,{})if not a.options.disable_keymaps then vim.api.nvim_set_keymap("n","<leader>px",":PxToRemCursor<CR>",{noremap=true,silent=true})vim.api.nvim_set_keymap("n","<leader>pxl",":PxToRemLine<CR>",{noremap=true,silent=true})end;if a.options.show_virtual_text then a.virtual_text()end;if a.options.add_cmp_source then local d=require("cmp")if not d then return end;local e=require("nvim-px-to-rem-cmp").add_to_cmp(a.options.root_font_size,a.options.decimal_count,a.options.filetypes)d.register_source("nvim_px_to_rem",e.new())end;return a.options end;a.virtual_text=function()a.namespace=vim.api.nvim_create_namespace("nvim-px-to-rem")local f={}for g,h in ipairs(a.options.filetypes)do table.insert(f,"*"..h)end;vim.api.nvim_create_autocmd({"BufEnter","BufWinEnter","CursorMoved","CursorMovedI"},{pattern=f,callback=function()a.px_to_rem()end})end;a.px_to_rem=function()local i=vim.api.nvim_win_get_cursor(0)[1]local j=vim.api.nvim_buf_get_lines(0,i-1,i,false)[1]local k={}for l in j:gmatch("(-?%d+%.?%d*)rem")do local m=tonumber(l)local n=m*a.options.root_font_size;local o=string.format("%spx",tostring(b.round(n,a.options.decimal_count)))table.insert(k,o)end;local p=vim.api.nvim_buf_get_extmark_by_id(0,a.namespace,a.namespace,{})if p~=nil then vim.api.nvim_buf_del_extmark(0,a.namespace,a.namespace)end;if#k>0 then vim.api.nvim_buf_set_extmark(0,tonumber(a.namespace),i-1,0,{virt_text={{table.concat(k," "),"Comment"}},id=a.namespace,priority=100})end end;a.px_to_rem_at_cursor=function()local q="%d+%.?%d*"local r=vim.fn.expand("<cWORD>")local s=string.match(r,q)if s==nil then return end;local n=tonumber(s)if n==nil then return end;local m=n/a.options.root_font_size;local l=string.format("%srem",tostring(b.round(m,a.options.decimal_count)))local t=r:gsub(q.."px",l)vim.cmd("normal! ciW"..t)end;a.px_to_rem_on_line=function()local i=vim.api.nvim_win_get_cursor(0)[1]local j=vim.api.nvim_buf_get_lines(0,i-1,i,false)[1]for l in j:gmatch("(-?%d+%.?%d*)px")do local m=tonumber(l)local n=m/a.options.root_font_size;local o=string.format("%srem",tostring(b.round(n,a.options.decimal_count)))local t=j:gsub("(-?%d+%.?%d*)px",o,1)vim.api.nvim_buf_set_lines(0,i-1,i,false,{t})j=vim.api.nvim_buf_get_lines(0,i-1,i,false)[1]end end;return a
