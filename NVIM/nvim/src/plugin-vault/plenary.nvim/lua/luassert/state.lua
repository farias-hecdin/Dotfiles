local a={__call=function(self)self:revert()end}local b={__mode="kv"}local c={}local d;local e={}e.revert=function(self)if not self then self=d;if not self.previous then return end end;if getmetatable(self)~=a then error("Value provided is not a valid snapshot",2)end;if self.next then self.next:revert()end;self.formatters={}self.parameters={}for f,g in pairs(self.spies)do self.spies[f]=nil;f:revert()end;setmetatable(self,nil)d=self.previous;d.next=nil end;e.snapshot=function()local h=setmetatable({formatters={},parameters={},spies=setmetatable({},b),previous=d,revert=e.revert},a)if d then d.next=h end;d=h;return d end;e.add_formatter=function(i)table.insert(d.formatters,1,i)end;e.remove_formatter=function(i,f)f=f or d;for j,k in ipairs(f.formatters)do if k==i then table.remove(f.formatters,j)break end end;if f.previous then e.remove_formatter(i,f.previous)end end;e.format_argument=function(l,f,m)f=f or d;for g,n in ipairs(f.formatters)do local o=n(l,m)if o~=nil then return o end end;if f.previous then return e.format_argument(l,f.previous,m)end;return nil end;e.set_parameter=function(p,q)if q==nil then q=c end;d.parameters[p]=q end;e.get_parameter=function(p,f)f=f or d;local l=f.parameters[p]if l==nil and f.previous then return e.get_parameter(p,f.previous)end;if l~=c then return l end;return nil end;e.add_spy=function(r)d.spies[r]=true end;e.snapshot()return e
