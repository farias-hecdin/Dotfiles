local a={}local b=require("utils")a.options={root_font_size=16,decimal_count=4,show_virtual_text=true,add_cmp_source=true,disable_keymaps=false,filetypes={"css","scss","sass"}}a.setup=function(c)c=c or{}a.options=vim.tbl_deep_extend("keep",c,a.options)vim.api.nvim_create_user_command("PxToRemCursor",a.px_to_rem_at_cursor,{})vim.api.nvim_create_user_command("PxToRemLine",a.px_to_rem_on_line,{})if not a.options.disable_keymaps then vim.api.nvim_set_keymap("n","<leader>px",":PxToRemCursor<CR>",{noremap=true,silent=true})vim.api.nvim_set_keymap("n","<leader>pxl",":PxToRemLine<CR>",{noremap=true,silent=true})end;if a.options.show_virtual_text then a.virtual_text()end;if a.options.add_cmp_source then vim.api.nvim_create_autocmd({"InsertEnter"},{once=true,pattern=vim.tbl_map(function(d)return"*"..d end,a.options.filetypes),callback=function(e)local f=require("cmp")if not f then return end;local g=require("nvim-px-to-rem-cmp").add_to_cmp(a.options.root_font_size,a.options.decimal_count,a.options.filetypes)f.register_source("nvim_px_to_rem",g.new())vim.api.nvim_del_autocmd(e.id)end})end;return a.options end;a.virtual_text=function()a.namespace=vim.api.nvim_create_namespace("nvim-px-to-rem")local h={}for i,d in ipairs(a.options.filetypes)do table.insert(h,"*"..d)end;vim.api.nvim_create_autocmd({"BufEnter","BufWinEnter","CursorMoved","CursorMovedI"},{pattern=h,callback=function()a.px_to_rem()end})end;a.px_to_rem=function()local j=vim.api.nvim_win_get_cursor(0)[1]local k=vim.api.nvim_buf_get_lines(0,j-1,j,false)[1]local l={}for m in k:gmatch("(-?%d+%.?%d*)rem")do local n=tonumber(m)local o=n*a.options.root_font_size;local p=string.format("%spx",tostring(b.round(o,a.options.decimal_count)))table.insert(l,p)end;local q=vim.api.nvim_buf_get_extmark_by_id(0,a.namespace,a.namespace,{})if q~=nil then vim.api.nvim_buf_del_extmark(0,a.namespace,a.namespace)end;local r=tonumber(a.namespace)if#l>0 and r~=nil then vim.api.nvim_buf_set_extmark(0,r,j-1,0,{virt_text={{table.concat(l," "),"Comment"}},id=a.namespace,priority=100})end end;a.px_to_rem_at_cursor=function()local s="%d+%.?%d*"local t=vim.fn.expand("<cWORD>")local u=string.match(t,s)if u==nil then return end;local o=tonumber(u)if o==nil then return end;local n=o/a.options.root_font_size;local m=string.format("%srem",tostring(b.round(n,a.options.decimal_count)))local v=t:gsub(s.."px",m)vim.cmd("normal! ciW"..v)end;a.px_to_rem_on_line=function()local j=vim.api.nvim_win_get_cursor(0)[1]local k=vim.api.nvim_buf_get_lines(0,j-1,j,false)[1]for m in k:gmatch("(-?%d+%.?%d*)px")do local n=tonumber(m)local o=n/a.options.root_font_size;local p=string.format("%srem",tostring(b.round(o,a.options.decimal_count)))local v=k:gsub("(-?%d+%.?%d*)px",p,1)vim.api.nvim_buf_set_lines(0,j-1,j,false,{v})k=vim.api.nvim_buf_get_lines(0,j-1,j,false)[1]end end;return a
