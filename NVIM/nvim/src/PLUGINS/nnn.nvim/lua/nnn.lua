local a=vim.api;local b=vim.o;local c=vim.loop;local d=vim.cmd;local e=vim.fn;local f=vim.schedule;local g=math.min;local h=math.max;local i=math.floor;local j,k,l,m,n,o,p;local q={win=a.nvim_get_current_win(),buf=a.nvim_get_current_buf()}local r={explorer={},picker={}}local s={builtin={}}local t=e.tempname().."-picker"local u=e.tempname().."-explorer"local v=os.getenv("NNN_OPTS")local w=os.getenv("XDG_CONFIG_HOME")or os.getenv("HOME").."/.config"local x=os.getenv("NNN_TMPFILE")or w.."/nnn/.lastd"local y=os.getenv("TMPDIR")or"/tmp"local z=os.getenv("TERM")local A=v and v:gsub("a","")or""local B={explorer={cmd="nnn",width=24,side="topleft",session="",tabs=true,fullscreen=true},picker={cmd="nnn",style={width=0.9,height=0.8,xoffset=0.5,yoffset=0.5,border="single"},session="",fullscreen=true},auto_open={setup=nil,tabpage=nil,empty=false,ft_ignore={"gitcommit"}},auto_close=false,replace_netrw=nil,mappings={},windownav={left="<C-w>h",right="<C-w>l",next="<C-w>w",prev="<C-w>W"},buflisted=false,quitcd=nil,offset=false}local C={foldcolumn="0",number=false,relativenumber=false,spell=false,wrap=false,winfixwidth=true,winfixheight=true,winhighlight="Normal:NnnNormal,NormalNC:NnnNormalNC,FloatBorder:NnnBorder"}local D={filetype="nnn"}local function E(F,G)if a.nvim_win_get_buf(r[F][G].win)~=r[F][G].buf then a.nvim_win_set_buf(r[F][G].win,r[F][G].buf)return end;if#a.nvim_tabpage_list_wins(0)==1 then a.nvim_win_set_buf(r[F][G].win,a.nvim_create_buf(false,false))else a.nvim_win_hide(r[F][G].win)end;r[F][G].win=nil;if q.win then a.nvim_set_current_win(q.win)end end;local function H(I,F,G)local J={}local K,L;local M,N=pcall(a.nvim_win_get_tabpage,q.win)if not q.win or N~=a.nvim_get_current_tabpage()then q.win=nil;for M,O in pairs(a.nvim_tabpage_list_wins(0))do if a.nvim_buf_get_name(a.nvim_win_get_buf(O))==""then K=O;break end;if a.nvim_buf_get_option(0,"filetype")~="nnn"then L=O end end;if not K and not L then d(m..b.columns-B.explorer.width-1 .."vsplit")q.win=a.nvim_get_current_win()end end;a.nvim_set_current_win(q.win or K or L)for P in I do if j then J[#J+1]=e.fnameescape(P)else pcall(d,"edit "..e.fnameescape(P))end end;if F=="explorer"and r[F][G].fs then a.nvim_win_close(r[F][G].win,{force=true})s.toggle("explorer",false,false)d("vert resize +1 | vert resize -1 | wincmd p")end;if j then f(function()j(J)j=nil end)end end;local function Q()local G=B.explorer.tabs and a.nvim_get_current_tabpage()c.fs_open(u,"r+",438,function(R,S)if R then f(function()print(R)end)else local T=c.new_pipe(false)T:open(S)T:read_start(function(U,V)if not U and V then f(function()H(V:gmatch("[^\n]+"),"explorer",G)end)else T:close()end end)end end)end;local function W(X,Y)local Z=c.fs_stat(X)return Z and Z.type==Y end;local function _(a0,a1)local a2,O;local F=r.picker[1]and r.picker[1].id==a0 and"picker"or"explorer"if F=="picker"then a2=1;O=r.picker[1].win else for G,a3 in pairs(r.explorer)do if a3.id==a0 then a2=G;O=a3.win;break end end end;if not a2 then return end;r[F][a2]={}if a1>0 then f(function()print(k and k[1]:sub(1,-2))end)else if B.quitcd then local S,M=io.open(x,"r")if S then d(B.quitcd..e.fnameescape(S:read():sub(5,-2)))S:close()os.remove(x)end end;if a.nvim_win_is_valid(O)then if#a.nvim_tabpage_list_wins(0)==1 then d("split")end;a.nvim_win_hide(O)local a4=a.nvim_list_bufs()if a.nvim_buf_get_name(a4[#a4])==""then a.nvim_buf_delete(a4[#a4],{})end end;if F=="picker"and W(t,"file")then H(io.lines(t),"picker",1)end end;if q then a.nvim_set_current_win(q.win)end end;local function a5(M,a6,M)k=a6 end;local function a7(a8)a.nvim_feedkeys(a.nvim_replace_termcodes(a8,true,true,true),"n",true)end;local function a9()for aa,ab in pairs(D)do a.nvim_buf_set_option(0,aa,ab)end;local ac={noremap=true}for ad,ae in ipairs(B.mappings)do a.nvim_buf_set_keymap(0,"t",ae[1],"<C-\\><C-n><cmd>lua require('nnn').handle_mapping("..ad..")<CR>",ac)end;a.nvim_buf_set_keymap(0,"t",B.windownav.left,"<C-\\><C-n><C-w>h",ac)a.nvim_buf_set_keymap(0,"t",B.windownav.right,"<C-\\><C-n><C-w>l",ac)a.nvim_buf_set_keymap(0,"t",B.windownav.next,"<C-\\><C-n><C-w>w",ac)a.nvim_buf_set_keymap(0,"t",B.windownav.prev,"<C-\\><C-n><C-w>W",ac)end;local function af(O,ag)a.nvim_win_call(O,function()d(a.nvim_buf_is_valid(q.buf)and q.buf~=ag and q.buf.."buffer"or"enew")end)end;local function ah(ai)local aj=b.lines;local ak=b.columns;local al={relative="editor",style="minimal",height=aj,width=ak,row=0,col=0}local am=B.picker.style;if ai then al.height=al.height-b.cmdheight else al.height=g(h(0,i(am.height>1 and am.height or aj*am.height)),aj)-1;al.width=g(h(0,i(am.width>1 and am.width or ak*am.width)),ak)-1;local an=i(am.yoffset>1 and am.yoffset or am.yoffset*(aj-al.height))-1;local ao=i(am.xoffset>1 and am.xoffset or am.xoffset*(ak-al.width))-1;al.row=g(h(0,an),aj-al.height)al.col=g(h(0,ao),ak-al.width)al.border=B.picker.style.border end;if B.offset then local P=io.open(y.."/nnn-preview-tui-posoffset","w")if P then P:write(al.col+1 .." "..al.row+1 .."\n")P:close()end end;return al end;local function ap(F,G,aq,ai)local ag=r[F][G]and r[F][G].buf;local ar=not ag;local O,al;if ar then ag=aq and a.nvim_get_current_buf()or a.nvim_create_buf(B.buflisted,false)end;if F=="picker"or ai then al=ah(ai)O=a.nvim_open_win(ag,true,al)else d(B.explorer.side.." "..B.explorer.width.."vsplit")O=a.nvim_get_current_win()end;a.nvim_win_set_buf(O,ag)return O,ag,ar end;local function as(F,G,aq,K)local a0=r[F][G]and r[F][G].id;local at=a.nvim_get_current_win()local au=B[F].fullscreen and#a.nvim_tabpage_list_wins(0)==1 and K;local O,ag,ar=ap(F,G,aq,au)if ar then local av=p and p or B[F].cmd;if l then av=av.." "..e.shellescape(l)end;a0=e.termopen(av,{cwd=not l and e.getcwd()or nil,env=F=="picker"and{TERM=z}or{TERM=z,NNN_OPTS=A,NNN_FIFO=u},on_exit=_,on_stdout=a5,stdout_buffered=true})p=nil;a9()if F=="explorer"then Q()end else a.nvim_win_set_buf(O,ag)end;for aa,ab in pairs(C)do a.nvim_win_set_option(0,aa,ab)end;r[F][G]={win=O,buf=ag,id=a0,fs=au}d("startinsert")if aq then af(at,ag)end end;function s.toggle(F,aw,ax)local ay;local az=a.nvim_buf_get_name(0)local aq=W(az,"directory")local K=(aq and e.bufname("#")or az)==""local G=F=="explorer"and B.explorer.tabs and a.nvim_get_current_tabpage()or 1;if aw then for M,aA in ipairs(aw)do if aA:find("^cmd=")then p=aA:sub(5)..(F=="picker"and" -p "..t..n or" -F1 "..o)else ay=aA end end end;if ax=="netrw"then if not aq then return end;if r[F][G]and r[F][G].buf then a.nvim_buf_delete(r[F][G].buf,{force=true})r[F][G]={}end elseif(ax=="setup"or ax=="tab")and(B.auto_open.empty and(not K and not aq)or vim.tbl_contains(B.auto_open.ft_ignore,a.nvim_buf_get_option(0,"filetype")))then return end;l=ay and e.expand(ay)or aq and az;local O=r[F][G]and r[F][G].win;O=B.explorer.tabs and O or vim.tbl_contains(a.nvim_tabpage_list_wins(0),O)if O and a.nvim_win_is_valid(O)then E(F,G)else as(F,G,aq,K)end end;function s.handle_mapping(aB)j=B.mappings[aB][2]a7("i<CR>")end;function s.win_enter()f(function()if a.nvim_buf_get_option(a.nvim_win_get_buf(0),"filetype")~="nnn"then q.win=a.nvim_get_current_win()q.buf=a.nvim_get_current_buf()elseif#a.nvim_tabpage_list_wins(0)==1 then q.win=nil end end)end;function s.win_closed()if a.nvim_win_get_config(0).zindex then return end;f(function()if a.nvim_buf_get_option(0,"filetype")~="nnn"then return end;local aC=0;for M,O in ipairs(a.nvim_tabpage_list_wins(0))do if not a.nvim_win_get_config(O).zindex then aC=aC+1 end end;if aC==1 then a7("<C-\\><C-n><cmd>q<CR>")end end)end;function s.tab_closed(G)local ag=r.explorer[G]and r.explorer[G].buf;if ag and a.nvim_buf_is_valid(ag)then a.nvim_buf_delete(ag,{force=true})end end;function s.vim_resized()local O,au;if r.picker[1]then au=r.picker[1].fs;O=r.picker[1].win else local G=B.explorer.tabs and a.nvim_get_current_tabpage()or 1;au=r.explorer[G]and r.explorer[G].fs;O=au and r.explorer[G]and r.explorer[G].win or nil end;if O and a.nvim_win_is_valid(O)then a.nvim_win_set_config(O,ah(au))end end;local function aD(J,aE)for M,P in ipairs(J)do d(aE.." "..P)end end;function s.builtin.open_in_split(J)aD(J,"split")end;function s.builtin.open_in_vsplit(J)aD(J,"vsplit")end;function s.builtin.open_in_tab(J)d("tabnew")aD(J,"edit")a7("<C-\\><C-n><C-w>h")end;function s.builtin.open_in_preview(J)local aF=a.nvim_get_current_buf()local aG=a.nvim_buf_get_name(aF)if aG==J[1]then return end;d("edit "..J[1])if aG~=""then a.nvim_buf_delete(aF,{})end;d("wincmd p")end;function s.builtin.copy_to_clipboard(J)J=table.concat(J,"\n")e.setreg("+",J)vim.defer_fn(function()print(J:gsub("\n",", ").." copied to register")end,0)end;function s.builtin.cd_to_path(J)local ay=J[1]:match(".*/"):sub(0,-2)local aH=io.open(ay:gsub("\\",""),"r")if aH~=nil then io.close(aH)e.execute("cd "..ay)vim.defer_fn(function()print("working directory changed to: "..ay)end,0)end end;function s.builtin.populate_cmdline(J)a7(": "..table.concat(J,"\n"):gsub("\n"," ").."<C-b>")end;function s.setup(aI)if aI then B=vim.tbl_deep_extend("force",B,aI)end;if B.replace_netrw then vim.g.loaded_netrw=1;vim.g.loaded_netrwPlugin=1;vim.g.loaded_netrwSettings=1;vim.g.loaded_netrwFileHandlers=1;pcall(a.nvim_clear_autocmds,{group="FileExplorer"})f(function()s.toggle(B.replace_netrw,nil,"netrw")a.nvim_create_autocmd({"BufEnter","BufNewFile"},{callback=function()require("nnn").toggle(B.replace_netrw,nil,"netrw")end})end)end;local aJ="nnn.nvim-"..os.date("%Y-%m-%d_%H-%M-%S")local aK=e.fnameescape(w.."/nnn/sessions/"..aJ)if B.picker.session=="shared"or B.explorer.session=="shared"then n=" -S -s "..aJ;o=n;a.nvim_create_autocmd("VimLeavePre",{command="call delete('"..aK.."')"})else if B.picker.session=="global"then n=" -S "elseif B.picker.session=="local"then n=" -S -s "..aJ.."-picker"a.nvim_create_autocmd("VimLeavePre",{command="call delete('"..aK.."-picker')"})else n=" "end;if B.explorer.session=="global"then o=" -S "elseif B.explorer.session=="local"then o=" -S -s "..aJ.."-explorer "a.nvim_create_autocmd("VimLeavePre",{command="call delete('"..aK.."-explorer')"})else o=" "end end;if not W(u,"fifo")then os.execute("mkfifo "..u)end;m=B.explorer.side:match("to")and"botright "or"topleft "B.picker.cmd=B.picker.cmd.." -p "..t..n;B.explorer.cmd=B.explorer.cmd.." -F1 "..o;if B.auto_open.setup and not(B.replace_netrw and W(a.nvim_buf_get_name(0),"directory"))then f(function()s.toggle(B.auto_open.setup,nil,"setup")end)end;if B.auto_close then a.nvim_create_autocmd("WinClosed",{callback=function()require("nnn").win_closed()end})end;if B.auto_open.tabpage then a.nvim_create_autocmd("TabNewEntered",{callback=function()vim.schedule(function()require("nnn").toggle(B.auto_open.tabpage,nil,"tab")end)end})end;a.nvim_create_user_command("NnnPicker",function(ac)require("nnn").toggle("picker",ac.fargs)end,{nargs="*"})a.nvim_create_user_command("NnnExplorer",function(ac)require("nnn").toggle("explorer",ac.fargs)end,{nargs="*"})local aL=a.nvim_create_augroup("nnn",{clear=true})a.nvim_create_autocmd("WinEnter",{group=aL,callback=function()require("nnn").win_enter()end})a.nvim_create_autocmd("TermClose",{group=aL,callback=function()if a.nvim_buf_get_option(0,"filetype")=="nnn"then a.nvim_buf_delete(0,{force=true})end end})a.nvim_create_autocmd("BufEnter",{group=aL,callback=function()if a.nvim_buf_get_option(0,"filetype")=="nnn"then vim.cmd("startinsert")end end})a.nvim_create_autocmd("VimResized",{group=aL,callback=function()if a.nvim_buf_get_option(0,"filetype")=="nnn"then require("nnn").vim_resized()end end})a.nvim_create_autocmd("TabClosed",{group=aL,callback=function(aM)require("nnn").tab_closed(tonumber(aM.file))end})a.nvim_set_hl(0,"NnnBorder",{link="FloatBorder",default=true})a.nvim_set_hl(0,"NnnNormal",{link="Normal",default=true})a.nvim_set_hl(0,"NnnNormalNC",{link="Normal",default=true})end;return s
